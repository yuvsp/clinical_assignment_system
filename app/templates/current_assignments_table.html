{% extends "base.html" %}

{% block content %}
<h1 class="mb-4 text-right">שיבוץ</h1>

<div class="mb-3 text-center">
    <label class="semester-label">סמסטר א</label>
    <label class="switch">
        <input type="checkbox" id="semester_toggle" onclick="toggleSemester()" {{ 'checked' if semester == 'א' else '' }}>
        <span class="slider round"></span>
    </label>
    <label class="semester-label">סמסטר ב</label>
</div>

<div class="mb-3 text-center">
    <form action="{{ url_for('main.import_backup_excel') }}" method="post" enctype="multipart/form-data" class="d-inline">
        <input type="file" name="file" class="form-control-file d-inline-block mb-2" required>
        <button type="submit" class="btn btn-warning">ייבא גיבוי אקסל</button>
    </form>
    <a href="{{ url_for('main.export_backup_excel') }}" class="btn btn-secondary">ייצא גיבוי אקסל</a>
</div>

<table class="table table-bordered mb-4 current-assignments-table" dir="rtl" style="table-layout: fixed; width: 100%;">
    <thead class="thead-light">
        <tr>
            <th class="text-right">שם הסטודנט</th>
            <th class="text-right">הקצאה</th>
            <th class="text-right">שיבוץ 1</th>
            <th class="text-right">שיבוץ 2</th>
            <th class="text-right">שיבוץ 3</th>
        </tr>
    </thead>
    <tbody>
        {% for student_data in student_assignments %}
        <tr>
            <td class="text-right">
                {{ student_data.name }}<br>
                <small>
                    1. {{ student_data.preferred_fields[0] }}<br>
                    2. {{ student_data.preferred_fields[1] }}<br>
                    3. {{ student_data.preferred_fields[2] }}
                </small>
            </td>
            <td class="text-right">
                <select class="form-control allocation-select" data-student-id="{{ student_data.id }}">
                    <option value="שפה" {{ 'selected' if student_data.allocation == 'שפה' else '' }}>שפה</option>
                    <option value="אודיו ושיקום" {{ 'selected' if student_data.allocation == 'אודיו ושיקום' else '' }}>אודיו ושיקום</option>
                </select>
            </td>
            {% if student_data.allocation == 'אודיו ושיקום' %}
                <td class="text-center" colspan="3">אודיו ושיקום</td>
            {% else %}
                {% for i in range(3) %}
                    {% if student_data.assignments[i] %}
                        {% set assignment = student_data.assignments[i] %}
                        {% set instructor = assignment.instructor %}
                        {% set reason = instructor and instructor.area_of_expertise and instructor.area_of_expertise.name not in student_data.preferred_fields and 'table-warning' %}
                        <td class="text-center {{ reason }}">
                            <form method="post" action="{{ url_for('main.remove_assignment', assignment_id=assignment.id) }}" class="d-inline">
                                <button type="submit" class="btn btn-cancel">ביטול שיבוץ</button>
                            </form>
                            <div style="margin-top: 5px;">
                                {{ instructor.area_of_expertise.name if instructor else '' }}
                                {{ instructor.name if instructor else '' }}<br>
                                יום {{ assignment.assigned_day }} ב{{ instructor.practice_location if instructor else '' }}<br>
                            </div>
                        </td>
                    {% else %}
                        <td class="text-center">
                            <div class="student-container">
                                <div class="student" onmouseover="fetchInstructors('{{ student_data.id }}', this.querySelector('.instructors-tooltip'))" data-student-id="{{ student_data.id }}">
                                    <a href="{{ url_for('main.assign_instructor', student_id=student_data.id) }}" class="btn btn-primary">שיבוץ</a>
                                    <div class="instructors-tooltip">טוען...</div>
                                </div>
                            </div>
                            <div style="margin-top: 5px;">לא שובץ עדיין</div>
                        </td>
                    {% endif %}
                {% endfor %}
            {% endif %}
        </tr>
        {% endfor %}
    </tbody>
</table>

<script>
function toggleSemester() {
    const toggle = document.getElementById('semester_toggle');
    const semester = toggle.checked ? 'א' : 'ב';
    window.location.href = `{{ url_for('main.current_assignments_table') }}?semester=${semester}`;
}

document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.allocation-select').forEach(function(selectElement) {
        selectElement.addEventListener('change', function() {
            const studentId = this.getAttribute('data-student-id');
            const allocation = this.value;
            fetch(`/update_allocation/${studentId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ allocation: allocation })
            }).then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Failed to update allocation');
                }
            }).catch(error => {
                console.error('Error updating allocation:', error);
            });
        });
    });
});
</script>

{% endblock %}

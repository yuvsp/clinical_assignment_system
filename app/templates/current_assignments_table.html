{% extends "base.html" %}

{% block content %}
<h1 class="mb-4 text-right">שיבוצים נוכחיים - טבלה</h1>

<div class="mb-3 text-center">
    <label class="semester-label">סמסטר א</label>
    <label class="switch">
        <input type="checkbox" id="semester_toggle" onclick="toggleSemester()" {{ 'checked' if semester == 'א' else '' }}>
        <span class="slider round"></span>
    </label>
    <label class="semester-label">סמסטר ב</label>
</div>

<div class="mb-3 text-center">
    <form action="{{ url_for('main.import_backup_excel') }}" method="post" enctype="multipart/form-data" class="d-inline">
        <input type="file" name="file" class="form-control-file d-inline-block mb-2" required>
        <button type="submit" class="btn btn-warning">ייבא גיבוי אקסל</button>
    </form>
    <a href="{{ url_for('main.export_backup_excel') }}" class="btn btn-secondary">ייצא גיבוי אקסל</a>
</div>

<table class="table table-bordered mb-4 current-assignments-table" dir="rtl" style="table-layout: fixed; width: 100%;">
    <thead class="thead-light">
        <tr>
            <th class="text-right">שם הסטודנט</th>
            <th class="text-right">שיבוץ 1</th>
            <th class="text-right">שיבוץ 2</th>
            <th class="text-right">שיבוץ 3</th>
        </tr>
    </thead>
    <tbody>
        {% for student_id, student_data in student_assignments.items() %}
        <tr>
            <td class="text-right">
                {{ student_data.name }}<br>
                <small>
                    1. {{ student_data.preferred_fields[0] }}<br>
                    2. {{ student_data.preferred_fields[1] }}<br>
                    3. {{ student_data.preferred_fields[2] }}
                </small>
            </td>
            {% for i in range(3) %}
                {% if student_data.assignments[i] %}
                    {% set reason = student_data.assignments[i].instructor.area_of_expertise.name not in student_data.preferred_fields and 'table-warning' %}
                    <td class="text-center {{ reason }}">
                        <form method="post" action="{{ url_for('main.remove_assignment', assignment_id=student_data.assignments[i].id) }}" class="d-inline">
                            <button type="submit" class="btn btn-danger">ביטול שיבוץ</button>
                        </form>
                        <div style="margin-top: 5px;">
                            יום {{ student_data.assignments[i].assigned_day }} ב{{ student_data.assignments[i].instructor.practice_location }}<br>
                            {{ student_data.assignments[i].instructor.name }}<br>
                            {{ student_data.assignments[i].instructor.area_of_expertise.name }}
                        </div>
                    </td>
                {% else %}
                    <td class="text-center">
                        <div class="student-container">
                            <div class="student" onmouseover="fetchInstructors('{{ student_id }}', this.querySelector('.instructors-tooltip'))" data-student-id="{{ student_id }}">
                                <a href="{{ url_for('main.assign_instructor', student_id=student_id) }}" class="btn btn-primary">שיבוץ</a>
                                <div class="instructors-tooltip">טוען...</div>
                            </div>
                        </div>
                        <div style="margin-top: 5px;">לא שובץ עדיין</div>
                    </td>
                {% endif %}
            {% endfor %}
        </tr>
        {% endfor %}
    </tbody>
</table>

<script>
function toggleSemester() {
    const toggle = document.getElementById('semester_toggle');
    const semester = toggle.checked ? 'א' : 'ב';
    window.location.href = `{{ url_for('main.current_assignments_table') }}?semester=${semester}`;
}
</script>

{% endblock %}
